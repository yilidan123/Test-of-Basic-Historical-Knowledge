```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜è€ƒå†å²åŸºç¡€çŸ¥è¯† - åŒäººç‹¬ç«‹å¯¹æˆ˜ v5 (ä¿®å¤ç‰ˆ)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
        }

        body {
            position: relative;
            cursor: none;
        }

        #gameCanvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        #divider {
            position: absolute;
            top: 0;
            left: 50%;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255,215,0,0.8), rgba(255,215,0,0.2), rgba(255,215,0,0.8));
            transform: translateX(-50%);
            z-index: 5;
            box-shadow: 0 0 10px #FFD700;
            display: none; /* Initially hidden */
        }

        #gameUI {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
            display: none; /* Hidden by default */
            flex-direction: row;
            justify-content: space-between;
            padding: 15px;
        }

        .player-ui {
            width: 48%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 11;
        }

        .player-ui.p1 { align-items: flex-start; }
        .player-ui.p2 { align-items: flex-end; }

        .question-display {
            font-size: 20px;
            text-align: center;
            color: #FFD700;
            text-shadow: 0 0 10px #FFD700;
            margin-top: 20px; /* MODIFIED: Increased margin-top */
            margin-bottom: 10px;
            font-weight: bold;
            background: rgba(0,0,0,0.6);
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid #FFD700;
            max-width: 95%; /* Increased max-width */
            min-height: 80px;
            pointer-events: auto;
        }

        .player-stats {
            width: 280px; /* Adjusted width */
            background: linear-gradient(135deg, rgba(0,100,255,0.3), rgba(0,200,255,0.2));
            padding: 10px;
            border-radius: 20px;
            border: 2px solid rgba(0,200,255,0.6);
            backdrop-filter: blur(8px);
            font-size: 16px;
            box-shadow: 0 0 15px rgba(0,200,255,0.4);
            text-align: center;
        }
         .player-stats.p2 {
            background: linear-gradient(135deg, rgba(255,0,100,0.3), rgba(255,0,200,0.2));
            border: 2px solid rgba(255,0,200,0.6);
            box-shadow: 0 0 15px rgba(255,0,200,0.4);
         }

        .player-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            text-shadow: 0 0 5px;
        }
        .player-stats.p1 .player-title { color: #60A5FA; }
        .player-stats.p2 .player-title { color: #F472B6; }

        .stat-item {
            display: inline-block;
            margin: 5px 8px; /* Increased margin */
            font-size: 15px; /* Slightly larger */
        }

        #crosshair, #crosshairP2 {
            position: fixed;
            width: 50px;
            height: 50px;
            pointer-events: none;
            z-index: 1000;
            transform: translate(-50%, -50%);
            transition: transform 0.1s linear;
        }

        #startScreen, #endScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at center, rgba(0,0,80,0.95), rgba(0,0,0,1));
            z-index: 100;
            text-align: center;
            cursor: auto;
            pointer-events: auto;
        }

        #startScreen { display: flex; }
        #endScreen { display: none; }


        .game-title {
            font-size: 56px;
            color: #FFD700;
            text-shadow: 0 0 30px #FFD700, 0 0 60px #FFA500;
            margin-bottom: 30px;
            animation: titleFloat 3s ease-in-out infinite;
            letter-spacing: 3px;
        }

        @keyframes titleFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .btn {
            padding: 18px 50px;
            font-size: 22px;
            background: linear-gradient(135deg, #1E90FF, #00BFFF, #4169E1);
            background-size: 200% 200%;
            animation: btnGradient 3s ease infinite;
            border: none;
            border-radius: 50px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
            box-shadow: 0 5px 25px rgba(30,144,255,0.5);
            position: relative;
            overflow: hidden;
            z-index: 105;
            pointer-events: auto;
        }

        @keyframes btnGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 35px rgba(30,144,255,0.7);
        }

        #wrongAnswers {
            margin-top: 20px;
            max-width: 900px;
            width: 90%;
            max-height: 250px;
            overflow-y: auto;
            background: rgba(0,0,0,0.6);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid rgba(255,215,0,0.3);
            backdrop-filter: blur(10px);
            z-index: 105;
            text-align: left;
        }

        .wrong-item {
            background: linear-gradient(to right, rgba(255,0,0,0.15), rgba(255,0,0,0.05));
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 10px;
            border-left: 5px solid #FF4444;
            font-size: 15px;
        }

        #soundToggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            border: 2px solid #FFD700;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            z-index: 101;
            pointer-events: auto;
        }

        #startScreen .controls-info {
            display: flex;
            justify-content: space-around;
            width: 80%;
            text-align: left;
            margin-top: 20px;
            color: #87CEEB;
            font-size: 16px;
        }
         #startScreen .controls-info div {
             background: rgba(0,0,0,0.3);
             padding: 15px;
             border-radius: 10px;
             border: 1px solid #87CEEB;
         }

        .winner-display {
            font-size: 72px;
            font-weight: bold;
            margin-bottom: 20px;
            animation: winnerPulse 1.5s ease-in-out infinite;
            z-index: 105;
            position: relative;
        }
        .p1-win { color: #60A5FA; text-shadow: 0 0 30px #60A5FA, 0 0 60px #00BFFF; }
        .p2-win { color: #F472B6; text-shadow: 0 0 30px #F472B6, 0 0 60px #FF00FF; }
        .draw { color: #FFD700; text-shadow: 0 0 30px #FFD700, 0 0 60px #FFA500; }

        @keyframes winnerPulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 20px;
            background-color: #f00;
            opacity: 0.9;
            animation: fall 5s linear infinite;
            z-index: 102;
        }

        @keyframes fall {
            0% { transform: translateY(-50px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }

        @keyframes correctAnswerAnim {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="divider"></div>

    <div id="crosshair"> <svg width="50" height="50"> <circle cx="25" cy="25" r="20" fill="none" stroke="#60A5FA" stroke-width="2" opacity="0.8"/> <circle cx="25" cy="25" r="3" fill="#60A5FA"/> <line x1="25" y1="5" x2="25" y2="15" stroke="#60A5FA" stroke-width="2"/> <line x1="25" y1="35" x2="25" y2="45" stroke="#60A5FA" stroke-width="2"/> <line x1="5" y1="25" x2="15" y2="25" stroke="#60A5FA" stroke-width="2"/> <line x1="35" y1="25" x2="45" y2="25" stroke="#60A5FA" stroke-width="2"/> </svg> </div>
    <div id="crosshairP2"> <svg width="50" height="50"> <circle cx="25" cy="25" r="20" fill="none" stroke="#F472B6" stroke-width="2" opacity="0.8"/> <circle cx="25" cy="25" r="3" fill="#F472B6"/> <line x1="25" y1="5" x2="25" y2="15" stroke="#F472B6" stroke-width="2"/> <line x1="25" y1="35" x2="25" y2="45" stroke="#F472B6" stroke-width="2"/> <line x1="5" y1="25" x2="15" y2="25" stroke="#F472B6" stroke-width="2"/> <line x1="35" y1="25" x2="45" y2="25" stroke="#F472B6" stroke-width="2"/> </svg> </div>

    <div id="soundToggle" onclick="toggleSound()">ğŸ”Š</div>

    <div id="gameUI">
        <div class="player-ui p1">
            <div class="question-display" id="questionP1">ç©å®¶1é¢˜ç›®åŒº</div>
            <div class="player-stats p1">
                <div class="player-title">ç©å®¶ 1 (é¼ æ ‡)</div>
                <div class="stat-item">ğŸ¯ å¾—åˆ†: <span id="scoreP1">0</span></div>
                <div class="stat-item">ğŸ“ <span id="currentP1">1</span>/10 é¢˜</div>
                <div class="stat-item">ğŸ”¥ è¿å‡»: <span id="comboP1">0</span></div>
            </div>
        </div>
        <div class="player-ui p2">
            <div class="question-display" id="questionP2">ç©å®¶2é¢˜ç›®åŒº</div>
             <div class="player-stats p2">
                 <div class="player-title">ç©å®¶ 2 (A/D/ç©ºæ ¼)</div>
                <div class="stat-item">ğŸ¯ å¾—åˆ†: <span id="scoreP2">0</span></div>
                <div class="stat-item">ğŸ“ <span id="currentP2">1</span>/10 é¢˜</div>
                <div class="stat-item">ğŸ”¥ è¿å‡»: <span id="comboP2">0</span></div>
            </div>
        </div>
    </div>

    <div id="startScreen">
        <h1 class="game-title">ğŸš€ é«˜è€ƒå†å²åŸºç¡€çŸ¥è¯† ğŸš€</h1>
        <p style="font-size: 24px; margin-bottom: 10px; color: #00BFFF;">åŒäººç‹¬ç«‹å¯¹æˆ˜</p>
        <p style="font-size: 18px; margin-bottom: 30px; color: #87CEEB;">å±å¹•åˆ†ä¸¤åŠï¼Œå„è‡ªä¸ºæˆ˜ï¼Œå¿…é¡»ç­”å®Œ10é¢˜ï¼</p>
        <button class="btn" onclick="startGame()">âš”ï¸ å¼€å§‹å¯¹æˆ˜</button>
        <div class="controls-info">
            <div> <p><strong>ç©å®¶ 1 (å·¦ä¾§):</strong></p> <p>ç§»åŠ¨é¼ æ ‡ç„å‡†</p> <p>ç‚¹å‡»å·¦é”®å°„å‡»</p> </div>
            <div> <p><strong>ç©å®¶ 2 (å³ä¾§):</strong></p> <p>A / D é”®ç§»åŠ¨</p> <p>ç©ºæ ¼é”®å°„å‡»</p> </div>
        </div>
        <div style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); text-align: center;">
             <p style="font-size: 16px; color: #FFD700; margin-bottom: 5px;">å¼€å‘è€…ï¼šä¼Šåˆ©ä¸¹</p>
             <p style="font-size: 14px; color: #87CEEB;">Â© 2024 é«˜è€ƒå†å²å­¦ä¹ æ¸¸æˆ (v5)</p>
         </div>
    </div>

    <div id="endScreen">
        <h1 class="game-title" style="font-size: 48px; margin-bottom: 20px; z-index: 105;">ğŸ¯ æŒ‘æˆ˜ç»“æŸ ğŸ¯</h1>
        <div class="winner-display" id="winnerDisplay"></div>
        <div style="display: flex; justify-content: center; gap: 40px; margin-bottom: 30px; z-index: 105;">
            <div style="text-align: center;">
                <p style="font-size: 20px; color: #60A5FA; margin-bottom: 10px;">ç©å®¶ 1 å¾—åˆ†</p>
                <p style="font-size: 56px; color: #60A5FA; font-weight: bold;"><span id="finalScoreP1">0</span></p>
            </div>
             <div style="text-align: center;">
                <p style="font-size: 20px; color: #F472B6; margin-bottom: 10px;">ç©å®¶ 2 å¾—åˆ†</p>
                <p style="font-size: 56px; color: #F472B6; font-weight: bold;"><span id="finalScoreP2">0</span></p>
            </div>
        </div>
        <button class="btn" onclick="restartGame()" style="font-size: 24px; padding: 20px 60px; margin-bottom: 20px; z-index: 105;">ğŸ”„ å†æˆ˜ä¸€æ¬¡</button>
        <div id="wrongAnswers"></div>
    </div>

    <script>
        // --- Get Elements ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const crosshairP1 = document.getElementById('crosshair');
        const crosshairP2 = document.getElementById('crosshairP2');
        const startScreen = document.getElementById('startScreen');
        const endScreen = document.getElementById('endScreen');
        const gameUI = document.getElementById('gameUI');
        const wrongAnswersDiv = document.getElementById('wrongAnswers');
        const divider = document.getElementById('divider');

        // --- Audio Context & Sound ---
        let audioContext = null;
        let soundEnabled = true;
        function initAudio() { try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { console.error("Web Audio API is not supported"); soundEnabled = false; } }
        function playSound(type, player = null) { if (!soundEnabled || !audioContext) return; const osc = audioContext.createOscillator(); const gain = audioContext.createGain(); const panner = audioContext.createStereoPanner(); osc.connect(gain); gain.connect(panner); panner.connect(audioContext.destination); panner.pan.value = player ? (player.id === 1 ? -0.9 : 0.9) : 0; switch(type) { case 'shoot': osc.frequency.value = 800; osc.type = 'square'; gain.gain.setValueAtTime(0.06, audioContext.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1); osc.start(); osc.stop(audioContext.currentTime + 0.1); break; case 'hit': osc.frequency.value = 400; osc.type = 'sine'; gain.gain.setValueAtTime(0.1, audioContext.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3); osc.start(); osc.stop(audioContext.currentTime + 0.3); break; case 'correct': osc.frequency.value = 600; osc.type = 'triangle'; gain.gain.setValueAtTime(0.12, audioContext.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.2); osc.start(); osc.stop(audioContext.currentTime + 0.2); break; case 'wrong': osc.frequency.value = 150; osc.type = 'sawtooth'; gain.gain.setValueAtTime(0.15, audioContext.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.4); osc.start(); osc.stop(audioContext.currentTime + 0.4); break; case 'win': [659.25, 783.99, 1046.50].forEach((freq, i) => { const o = audioContext.createOscillator(), g = audioContext.createGain(), p = audioContext.createStereoPanner(); o.connect(g); g.connect(p); p.connect(audioContext.destination); o.frequency.value = freq; o.type = 'triangle'; p.pan.value = 0; g.gain.setValueAtTime(0.15, audioContext.currentTime + i * 0.15); g.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + i * 0.15 + 0.3); o.start(audioContext.currentTime + i * 0.15); o.stop(audioContext.currentTime + i * 0.15 + 0.3); }); break; } }
        function toggleSound() { soundEnabled = !soundEnabled; document.getElementById('soundToggle').textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡'; if(soundEnabled && !audioContext) initAudio(); }

        // --- Game Variables ---
        let p1Rect, p2Rect;
        let gameState = 'menu';
        let particles = [];
        let stars = [];
        let p2Keys = { left: false, right: false, shoot: false };
        let mouseX = 0, mouseY = 0;
        let player1 = {};
        let player2 = {};

        const questionBank = [ /* ... Full question bank here ... */
            { question: "å½“å‰å®˜æ–¹è§‚ç‚¹æ˜¯ï¼šä¸­å›½æœ‰_____å¹´çš„æ–‡æ˜å²", correctAnswer: "5åƒ", wrongAnswers: ["100ä¸‡å¹´", "1ä¸‡å¹´", "3åƒå¹´"] },
            { question: "ç§‘ä¸¾åˆ¶åºŸé™¤äº_____æ—¶æœŸ", correctAnswer: "æ¸…æœ«æ–°æ”¿", wrongAnswers: ["ä¸­åæ°‘å›½ä¸´æ—¶æ”¿åºœ", "æ–°æ–‡åŒ–è¿åŠ¨", "æˆŠæˆŒå˜æ³•"] },
            { question: "ç§‘ä¸¾åˆ¶æ­£å¼åºŸé™¤äº_____å¹´", correctAnswer: "1905", wrongAnswers: ["1911", "1912", "1901"] },
            { question: "å½“å‰å®˜æ–¹è§‚ç‚¹æ˜¯ï¼š_____æ–‡åŒ–ï¼Œå®è¯ä¸­åæ–‡æ˜äº”åƒå¹´", correctAnswer: "è‰¯æ¸š", wrongAnswers: ["é™¶å¯º", "çº¢å±±", "ä»°éŸ¶"] },
            { question: "æˆ˜å›½åˆæœŸï¼Œå¯¹å„’å®¶æ„æˆå·¨å¤§å‹åŠ›çš„æ˜¯_____ã€‚", correctAnswer: "å¢¨å®¶ä¸æ¨æœ±å­¦æ´¾", wrongAnswers: ["æ³•å®¶ä¸é“å®¶", "ä½›æ•™ä¸é“æ•™", "å®—æ•™ç¥å­¦è§‚"] },
            { question: "å°å†œç»æµäº§ç”Ÿäº_____æ—¶æœŸã€‚", correctAnswer: "æ˜¥ç§‹æˆ˜å›½", wrongAnswers: ["æ–°çŸ³å™¨æ—¶ä»£åˆæœŸ", "è¥¿å‘¨", "é­æ™‹åº„å›­ç»æµ"] },
            { question: "å„’å­¦åœ¨æ±‰ä»£å¼€å§‹äº†_____åŒ–ã€‚", correctAnswer: "ç¥å­¦", wrongAnswers: ["ä¼¦ç†å­¦", "å“²å­¦", "ç§‘å­¦"] },
            { question: "å„’å­¦åœ¨_____æ—¶æœŸå®Œæˆäº†å“²å­¦åŒ–ã€‚", correctAnswer: "å®‹æ˜", wrongAnswers: ["æˆ˜å›½", "æ±‰ä»£", "æ˜æ¸…"] },
            { question: "æ–°ç–†åœ¨_____æ—¶æœŸæ­£å¼çº³å…¥ä¸­å›½ç‰ˆå›¾ã€‚", correctAnswer: "è¥¿æ±‰", wrongAnswers: ["ç§¦æœ", "å”æœ", "å…ƒæœ"] },
            { question: "è¥¿è—åœ¨_____æ—¶æœŸæ­£å¼çº³å…¥ä¸­å›½ç‰ˆå›¾ã€‚", correctAnswer: "å…ƒæœ", wrongAnswers: ["æ±‰æœ", "å”æœ", "æ˜æœ"] },
            { question: "åº·ç†™æ—¶æœŸï¼Œæ¸…æ”¿åºœåœ¨å°æ¹¾è®¾____ï¼Œéš¶å±ç¦å»ºçœ", correctAnswer: "åºœ", wrongAnswers: ["å¿", "å·", "çœ"] },
            { question: "_____æˆ˜äº‰åï¼Œæ¸…æ”¿åºœåœ¨å°æ¹¾æ­£å¼è®¾çœã€‚", correctAnswer: "ä¸­æ³•", wrongAnswers: ["é¸¦ç‰‡", "ç”²åˆä¸­æ—¥", "å…«å›½è”å†›ä¾µå"] },
            { question: "ç§è¥æ‰‹å·¥ä¸šè¶…è¿‡å®˜è¥å¼€å§‹äº_____", correctAnswer: "æ˜æœä¸­åæœŸ", wrongAnswers: ["æ˜¥ç§‹æˆ˜å›½", "å®‹å…ƒæ—¶æœŸ", "é¸¦ç‰‡æˆ˜äº‰å"] },
            { question: "æ±‰å­—ã€ç»˜ç”»çš„è‰ºæœ¯åŒ–å¼€å§‹äº____æ—¶æœŸ", correctAnswer: "é­æ™‹", wrongAnswers: ["é™¶å¯º", "æ˜¥ç§‹æˆ˜å›½", "å”"] },
            { question: "â€œåå¤è®¤åŒâ€è§‚å¿µå¼€å§‹äº____æ—¶æœŸ", correctAnswer: "ä¸œå‘¨", wrongAnswers: ["æ–°çŸ³å™¨æ—¶ä»£", "è¥¿å‘¨", "ç§¦æ±‰"] },
            { question: "ç§Ÿåº¸è°ƒåˆ¶ä»____å¼€å§‹å®è¡Œ", correctAnswer: "å”æœ", wrongAnswers: ["æ±‰", "åŒ—é­", "æ¸…"] },
            { question: "ç‡å…ˆåœ¨å…¨å›½é€šè¡Œçº¸å¸çš„æ˜¯___", correctAnswer: "å…ƒä»£", wrongAnswers: ["æ±‰æ­¦å¸ä»¥å", "å®‹ä»£", "æ˜ä»£"] },
            { question: "è®¾ç«‹å†…é˜å¤§å­¦å£«çš„æ˜¯____", correctAnswer: "æ˜æˆç¥–", wrongAnswers: ["æ˜å¤ªç¥–", "æ˜å®ªå®—", "ä¸‡å†å¸"] },
            { question: "_____ï¼Œç»æµé‡å¿ƒå¼€å§‹å—ç§»ã€‚", correctAnswer: "å®‰å²ä¹‹ä¹±å", wrongAnswers: ["é­æ™‹å—åŒ—æœ", "ä¸¤å®‹æ—¶æœŸ", "æ˜ä¸­åæœŸ"] },
            { question: "æ˜æœèµ·æ­¢æ—¶é—´æ˜¯____å¹´", correctAnswer: "1368--1644", wrongAnswers: ["960--1279", "1566--1644", "1644-1765"] },
            { question: "ä¸­å›½è‡ªç„¶ç»æµå¼€å§‹è§£ä½“äº_____", correctAnswer: "é¸¦ç‰‡æˆ˜äº‰å", wrongAnswers: ["æ™šæ˜æ—¶æœŸ", "ç”²åˆæˆ˜å", "æ–°ä¸­å›½æˆç«‹"] },
            { question: "ä¸ä¸­å›½åŒç›Ÿä¼šäº§ç”ŸåŒä¸€å¹´çš„æ˜¯____", correctAnswer: "äº”å¤§è‡£å‡ºæ´‹è€ƒå¯Ÿå®ªæ”¿", wrongAnswers: ["ç”²åˆä¸­æ—¥æˆ˜äº‰", "ã€Šè¾›ä¸‘æ¡çº¦ã€‹ç­¾è®¢", "â€œçš‡æ—å†…é˜â€äº§ç”Ÿ"] },
            { question: "ä¸â€œçš‡æ—å†…é˜â€åŒä¸€å¹´å‡ºç°çš„æ˜¯____", correctAnswer: "æ­¦æ˜Œèµ·ä¹‰", wrongAnswers: ["ã€Šè¾›ä¸‘æ¡çº¦ã€‹ç­¾è®¢", "ã€Šé’¦å®šå®ªæ³•å¤§çº²ã€‹é¢å¸ƒ", "å…‰ç»ªå’Œæ…ˆç¦§å»ä¸–"] },
            { question: "ä¸œå—äº’ä¿ä¸____åŒæ—¶", correctAnswer: "ä¹‰å’Œå›¢è¿åŠ¨", wrongAnswers: ["å¤ªå¹³å¤©å›½è¿åŠ¨", "æ´‹åŠ¡è¿åŠ¨", "è¾›äº¥é©å‘½"] },
            { question: "åˆ—å®é€ä¸–åŒä¸€å¹´å‘ç”Ÿçš„æ˜¯____", correctAnswer: "å›½æ°‘å…šä¸€å¤§å¬å¼€", wrongAnswers: ["äº”å››è¿åŠ¨", "åŒ—ä¼å¼€å§‹", "å—æ˜Œèµ·ä¹‰"] },
            { question: "ä¸å›½æ°‘å…šå½¢å¼ä¸Šç»Ÿä¸€å…¨å›½åœ¨åŒä¸€å¹´çš„æ˜¯____", correctAnswer: "äº•å†ˆå±±ä¼šå¸ˆ", wrongAnswers: ["å—æ˜Œèµ·ä¹‰", "äº•å†ˆå±±æ ¹æ®åœ°å¼€å§‹å»ºç«‹", "ä¸­åŸå¤§æˆ˜"] },
            { question: "ç”²åˆæˆ˜å____å¹´ï¼Œæ—¥ä¿„æˆ˜äº‰çˆ†å‘ã€‚", correctAnswer: "å", wrongAnswers: ["ä¸¤å¹´", "äº”å¹´", "äºŒåå¹´"] },
            { question: "å›½æ°‘å…šæ”¿åºœæ¨è¡Œæ³•å¸æ”¿ç­–æ˜¯åœ¨____å¹´", correctAnswer: "1935", wrongAnswers: ["1933", "1937", "1948"] },
            { question: "å›½æ°‘å…šæ”¿åºœâ€œè®­æ”¿â€é˜¶æ®µçš„æ—¶é—´æ˜¯____å¹´æœŸé—´ã€‚", correctAnswer: "1928--1948", wrongAnswers: ["1912--1927", "1927--1937", "1937--1945"] },
            { question: "æ¸…æœå¯¹å¤–è´¸æ˜“ç¬¬ä¸€æ¬¡å‡ºç°å…¥è¶…æ˜¯åœ¨____å¹´ã€‚", correctAnswer: "1865", wrongAnswers: ["1842", "1895", "1901"] },
            { question: "ã€Šèµ„æ”¿æ–°ç¯‡ã€‹é¢å¸ƒçš„åŒä¸€å¹´ï¼Œ_____å‘è¡¨ã€‚", correctAnswer: "ã€Šç‰©ç§èµ·æºã€‹", wrongAnswers: ["â€œæ—¥å¿ƒè¯´â€", "ã€Šå¤©æœç”°äº©åˆ¶åº¦ã€‹", "ä¸‰æ°‘ä¸»ä¹‰"] },
            { question: "å¤ªå¹³å¤©å›½è¿åŠ¨çš„èµ·æ­¢æ—¶é—´æ˜¯____å¹´ã€‚", correctAnswer: "1851--1864", wrongAnswers: ["1856--1860", "1861--1895", "1860--1885"] },
            { question: "ã€Šå¤©æœç”°äº©åˆ¶åº¦ã€‹é¢å¸ƒ100å‘¨å¹´æ—¶ï¼Œä¸­å›½å¼€å§‹è¿›è¡Œ_____ã€‚", correctAnswer: "å†œä¸šåˆä½œåŒ–", wrongAnswers: ["åœŸåœ°æ”¹é©è¿åŠ¨", "äººæ°‘å…¬ç¤¾åŒ–", "å®¶åº­è”äº§æ‰¿åŒ…è´£ä»»åˆ¶"] },
            { question: "ä¸å±äºä¸­å›½19ä¸–çºª70å¹´ä»£å‡ºç°çš„æ˜¯____ã€‚", correctAnswer: "ä¸­æ³•æˆ˜äº‰", wrongAnswers: ["æ°‘æ—èµ„æœ¬ä¸»ä¹‰äº§ç”Ÿ", "æ´‹åŠ¡æ´¾æ°‘ç”¨å·¥ä¸šå¼€å§‹", "è¾¹ç–†å±æœº"] },
            { question: "å±äºä¸­å›½19ä¸–çºª40å¹´ä»£å‡ºç°çš„æ˜¯____ã€‚", correctAnswer: "äº”å£é€šå•†", wrongAnswers: ["æ´‹åŠ¡è¿åŠ¨", "ç«çƒ§åœ†æ˜å›­", "å¤ªå¹³å¤©å›½è¿åŠ¨"] },
            { question: "å±äºä¸­å›½19ä¸–çºª50å¹´ä»£å‡ºç°çš„æ˜¯____ã€‚", correctAnswer: "å†œæ°‘è¿åŠ¨è¾¾åˆ°äº†æœ€é«˜å³°", wrongAnswers: ["è¿‘ä»£å·¥ä¸šåŒ–å¼€å§‹", "è¾¹ç–†å±æœº", "å®‰åº†å†…å†›æ¢°æ‰€"] },
            { question: "ç”²åˆä¸­æ—¥æˆ˜äº‰å‘ç”Ÿåœ¨____å¹´ã€‚", correctAnswer: "1894--1895", wrongAnswers: ["1883--1885", "1898", "1900--1901"] },
            { question: "åˆ—å¼ºå¯¹åèµ„æœ¬è¾“å‡ºä¸ºä¸»çš„æ—¶é—´æ˜¯____ä»¥åã€‚", correctAnswer: "ç”²åˆæˆ˜äº‰", wrongAnswers: ["é¸¦ç‰‡æˆ˜äº‰", "å¤ªå¹³å¤©å›½è¿åŠ¨", "ã€Šè¾›ä¸‘æ¡çº¦ã€‹ç­¾è®¢"] },
            { question: "åˆ—å¼ºç“œåˆ†ä¸­å›½çš„ç‹‚æ½®å¼€å§‹äº____å¹´ã€‚", correctAnswer: "1897", wrongAnswers: ["1860", "1898", "1901"] },
            { question: "æ¸…æ”¿åºœå®£å¸ƒâ€œé¢„å¤‡ç«‹å®ªâ€å¼€å§‹äº____å¹´ã€‚", correctAnswer: "1906", wrongAnswers: ["1901", "1905", "1908"] },
            { question: "ä¸å±äº1908å¹´å‘ç”Ÿçš„æ˜¯____ã€‚", correctAnswer: "â€œçš‡æ—å†…é˜â€å‡ºå°", wrongAnswers: ["æ…ˆç¦§å»ä¸–", "ã€Šé’¦å®šå®ªæ³•å¤§çº²ã€‹", "å…‰ç»ªå»ä¸–"] },
            { question: "å±äº1912å¹´1æœˆä»½çš„æ˜¯____ã€‚", correctAnswer: "æ°‘å›½å»ºç«‹", wrongAnswers: ["æ¸…æœç­äº¡", "åŒ—æ´‹æ”¿åºœæˆç«‹", "ã€Šä¸´æ—¶çº¦æ³•ã€‹é¢å¸ƒ"] },
            { question: "ä¸¤ç¨æ³•äº§ç”Ÿçš„èƒŒæ™¯æ˜¯____ã€‚", correctAnswer: "å®‰å²ä¹‹ä¹±ä»¥å", wrongAnswers: ["è´è§‚å¹´é—´", "å¼€å…ƒç››ä¸–", "å‡ç”°åˆ¶ç››è¡Œ"] },
            { question: "è®¾ç½®é©»è—å¤§è‡£çš„æœä»£æ˜¯____æœã€‚", correctAnswer: "æ¸…", wrongAnswers: ["æ±‰", "å”", "å…ƒ"] },
            { question: "è®¾ç½®åä¸‰è¡Œå¯¹å¤–è´¸æ˜“æœºæ„çš„æ˜¯____æœã€‚", correctAnswer: "æ¸…", wrongAnswers: ["å”", "å®‹", "å…ƒ"] },
            { question: "ä¸¤æ¡ä¸ç»¸ä¹‹è·¯æœ€æ—©å¼€é€šäº____æœã€‚", correctAnswer: "æ±‰", wrongAnswers: ["ç§¦", "å”", "å…ƒ"] },
            { question: "ä¸å±äºæ±‰æ­¦å¸æ—¶æœŸçš„æ˜¯å®è¡Œ____æ”¿ç­–ã€‚", correctAnswer: "å‰Šè—©", wrongAnswers: ["äº”ç»åšå£«", "ä¸­æœåˆ¶", "ç›é“å®˜è¥"] },
            { question: "ä¸‹åˆ—å±äºæ±‰æ­¦å¸æ—¶æœŸä¸è¥¿åŸŸå…³ç³»çš„æ˜¯____ã€‚", correctAnswer: "å¼ éªé€šè¥¿åŸŸ", wrongAnswers: ["è®¾ç«‹è¥¿åŸŸéƒ½æŠ¤", "è®¾ç«‹å®‰è¥¿éƒ½æŠ¤åºœ", "è®¾ç«‹åŒ—åº­éƒ½æŠ¤åºœ"] },
            { question: "ååŒ—äº”çœä¸å…è®¸ç§‘ä¸¾è€ƒè¯•ï¼Œæœ€æ—©å§‹äº____å¹´ã€‚", correctAnswer: "1901", wrongAnswers: ["1860", "1895", "1912"] },
            { question: "ä¸–ç•Œä¸Šæœ€æ—©ç”±å›½å®¶é¢è¡Œçš„è¯å…¸æ˜¯åœ¨____æœã€‚", correctAnswer: "å”", wrongAnswers: ["æ±‰", "å®‹", "å…ƒ"] },
            { question: "ä¸­å›½ç°å­˜æœ€æ—©çš„ä¸€éƒ¨å®Œæ•´çš„å†œä¹¦äº§ç”Ÿäº____æ—¶æœŸã€‚", correctAnswer: "åŒ—æœ", wrongAnswers: ["æ±‰æœ", "å”æœ", "äº”ä»£"] },
            { question: "â€œå–å£«ä¸é—®å®¶ä¸–ï¼Œå©šå§»ä¸é—®é˜€é˜…â€æ˜¯____ä»£çš„ç°è±¡ã€‚", correctAnswer: "å®‹", wrongAnswers: ["å‘¨", "é­æ™‹", "å”"] },
            { question: "ç†å­¦æˆä¸ºå®˜æ–¹æ­£ç»Ÿæ€æƒ³çš„æ˜¯åœ¨____ã€‚", correctAnswer: "å—å®‹ä»¥å", wrongAnswers: ["åŒ—å®‹ä¸­æœŸ", "å—å®‹ä¸­æœŸ", "æ˜æœåˆæœŸ"] },
            { question: "å€­å¯‡ä¸æ–­å¯¹æˆ‘å›½ä¸œéƒ¨æ²¿æµ·è¿›è¡Œä¾µæ‰°å¼€å§‹äº____ã€‚", correctAnswer: "å…ƒæœæœ«æœŸ", wrongAnswers: ["ä¸¤å®‹ä¹‹é™…", "æ˜æœåˆæœŸ", "æ˜æœä¸­æœŸ"] },
            { question: "ã€Šå°¼å¸ƒæ¥šæ¡çº¦ã€‹ç­¾è®¢åœ¨____å¹´ã€‚", correctAnswer: "1689", wrongAnswers: ["1553", "1662", "1684"] },
            { question: "æ€æƒ³å®¶æè´½æ˜¯____çš„é‡è¦æ€æƒ³å®¶ã€‚", correctAnswer: "æ˜æœä¸­åæœŸ", wrongAnswers: ["æ˜æœä¸­æœŸ", "æ˜æœ«æ¸…åˆ", "æ¸…æœä¸­æœŸ"] },
            { question: "äº¬å‰§å½¢æˆäºæ¸…æœ____æ—¶æœŸã€‚", correctAnswer: "é“å…‰", wrongAnswers: ["åº·ç†™", "ä¹¾éš†", "åŒæ²»"] },
            { question: "é“æ•™å…´èµ·äº____ã€‚", correctAnswer: "ä¸œæ±‰æœ«å¹´", wrongAnswers: ["æ˜¥ç§‹", "æˆ˜å›½", "è¥¿æ±‰æœ«æœŸ"] },
            { question: "å®‰å²ä¹‹ä¹±å‘ç”Ÿçš„æ—¶é—´æ˜¯____ã€‚", correctAnswer: "8ä¸–çºªä¸­æœŸ", wrongAnswers: ["6ä¸–çºªæ™šæœŸ", "7ä¸–çºªåˆæœŸ", "10ä¸–çºªåˆæœŸ"] }
        ];

        // --- Functions ---
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; p1Rect = { x: 0, y: 0, width: canvas.width / 2, height: canvas.height }; p2Rect = { x: canvas.width / 2, y: 0, width: canvas.width / 2, height: canvas.height }; if (player1 && player1.y) player1.y = canvas.height - 150; if (player2 && player2.y) player2.y = canvas.height - 150; if(divider) divider.style.height = canvas.height + 'px'; }
        function initPlayer(id, rect, color, j20Body, j20Wing) {
            return {
                id: id,
                x: rect.x + rect.width / 2,
                y: canvas.height - 150,
                targetX: rect.x + rect.width / 2,
                angle: 0,
                speed: id === 1 ? 0.2 : 8,
                score: 0,
                // lives: 3, // MODIFIED: Removed lives
                combo: 0,
                maxCombo: 0,
                bullets: [],
                targets: [],
                questions: [],
                currentQuestionIndex: 0,
                currentQuestionData: null,
                questionAnswered: false,
                wrongAnswers: [],
                rect: rect,
                color: color,
                j20Body: j20Body,
                j20Wing: j20Wing,
                shootCooldown: 0,
                isFinished: false,
            };
        }
        function createStars() { stars = []; for (let i = 0; i < 200; i++) { stars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: Math.random() * 2 + 0.5, speed: Math.random() * 0.5 + 0.1, brightness: Math.random() }); } }
        function drawBackground() { const gradient = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width); gradient.addColorStop(0, '#0a0a2e'); gradient.addColorStop(0.5, '#16213e'); gradient.addColorStop(1, '#000000'); ctx.fillStyle = gradient; ctx.fillRect(0, 0, canvas.width, canvas.height); stars.forEach(star => { ctx.fillStyle = `rgba(255, 255, 255, ${star.brightness})`; ctx.fillRect(star.x, star.y, star.size, star.size); star.y += star.speed; if (star.y > canvas.height + 10) { star.y = -10; star.x = Math.random() * canvas.width; } }); }
        function drawJ20(player) { if(player.id === 1) { player.x += (player.targetX - player.x) * player.speed; } else { if(p2Keys.left) player.x -= player.speed; if(p2Keys.right) player.x += player.speed; } player.x = Math.max(player.rect.x + 50, Math.min(player.rect.x + player.rect.width - 50, player.x)); player.angle = (player.targetX - player.x) * (player.id === 1 ? 0.0004 : 0); ctx.save(); ctx.translate(player.x, player.y); ctx.rotate(player.angle); ctx.shadowColor = player.color; ctx.shadowBlur = 15; const bodyGradient = ctx.createLinearGradient(0, -50, 0, 50); bodyGradient.addColorStop(0, player.j20Body); bodyGradient.addColorStop(1, player.j20Wing); ctx.fillStyle = bodyGradient; ctx.beginPath(); ctx.moveTo(0, -50); ctx.lineTo(-10, -30); ctx.lineTo(-15, 0); ctx.lineTo(-18, 35); ctx.lineTo(-12, 50); ctx.lineTo(0, 45); ctx.lineTo(12, 50); ctx.lineTo(18, 35); ctx.lineTo(15, 0); ctx.lineTo(10, -30); ctx.closePath(); ctx.fill(); ctx.fillStyle = player.j20Wing; ctx.beginPath(); ctx.moveTo(-15, -5); ctx.lineTo(-50, 20); ctx.lineTo(-45, 40); ctx.lineTo(-18, 30); ctx.closePath(); ctx.fill(); ctx.beginPath(); ctx.moveTo(15, -5); ctx.lineTo(50, 20); ctx.lineTo(45, 40); ctx.lineTo(18, 30); ctx.closePath(); ctx.fill(); const cockpitGradient = ctx.createRadialGradient(0, -25, 0, 0, -25, 15); cockpitGradient.addColorStop(0, `rgba(${player.id === 1 ? '100, 200, 255' : '255, 100, 180'}, 0.9)`); cockpitGradient.addColorStop(1, `rgba(${player.id === 1 ? '50, 150, 200' : '200, 50, 130'}, 0.6)`); ctx.fillStyle = cockpitGradient; ctx.beginPath(); ctx.ellipse(0, -25, 8, 15, 0, 0, Math.PI * 2); ctx.fill(); ctx.shadowColor = 'rgba(255, 100, 0, 0.8)'; ctx.shadowBlur = 20; for (let i = -1; i <= 1; i += 2) { const flameLength = 30 + Math.random() * 20; const flameGradient = ctx.createLinearGradient(i*8, 45, i*8, 45 + flameLength); flameGradient.addColorStop(0, 'rgba(255, 200, 100, 0.9)'); flameGradient.addColorStop(0.5, 'rgba(255, 100, 50, 0.7)'); flameGradient.addColorStop(1, 'rgba(255, 50, 0, 0)'); ctx.fillStyle = flameGradient; ctx.beginPath(); ctx.moveTo(i*8 - 5, 45); ctx.lineTo(i*8 - 3, 50); ctx.lineTo(i*8, 45 + flameLength); ctx.lineTo(i*8 + 3, 50); ctx.lineTo(i*8 + 5, 45); ctx.closePath(); ctx.fill(); } ctx.shadowBlur = 0; ctx.restore(); }
        function createTargets(player) { if (!player.currentQuestionData || player.isFinished) return; player.targets = []; const data = player.currentQuestionData; const answers = [data.correctAnswer, ...data.wrongAnswers.slice(0, 3)].sort(() => Math.random() - 0.5); for (let i = 0; i < 4; i++) { const shapeData = []; const points = 12 + Math.floor(Math.random() * 4); for (let j = 0; j < points; j++) { shapeData.push({ angle: (j / points) * Math.PI * 2, radiusOffset: Math.random() * 20 - 10 }); } player.targets.push({ x: player.rect.x + (i + 0.5) * (player.rect.width / 4), y: -150 - Math.random() * 100, text: answers[i], isCorrect: answers[i] === data.correctAnswer, speed: 1.05 + player.currentQuestionIndex * 0.1, size: 70, hit: false, shapeData: shapeData, glowPhase: Math.random() * Math.PI * 2 }); } }

        function drawTargets(player) {
            player.targets.forEach(target => {
                if (target.hit) return;
                ctx.save();
                ctx.translate(target.x, target.y);

                // --- Draw Asteroid ---
                const glow = Math.sin(Date.now() * 0.003 + target.glowPhase) * 0.3 + 0.7;
                ctx.shadowColor = 'rgba(100, 150, 255, 0.8)';
                ctx.shadowBlur = 15 * glow;
                ctx.fillStyle = '#4A90E2';
                ctx.beginPath();
                const baseRadius = target.size / 2;
                target.shapeData.forEach((point, i) => { const radius = baseRadius + point.radiusOffset; const x = Math.cos(point.angle) * radius; const y = Math.sin(point.angle) * radius; if (i === 0) { ctx.moveTo(x, y); } else { ctx.lineTo(x, y); } });
                ctx.closePath();
                ctx.fill();
                ctx.fillStyle = '#60A5FA';
                for (let i = 0; i < 3; i++) { const dotX = (Math.random() - 0.5) * target.size * 0.7; const dotY = (Math.random() - 0.5) * target.size * 0.7; ctx.beginPath(); ctx.arc(dotX, dotY, 2, 0, Math.PI * 2); ctx.fill(); }
                ctx.shadowBlur = 0;

                // --- Draw Text Box (MODIFIED) ---
                ctx.font = 'bold 18px Microsoft YaHei'; // Increased font size
                const metrics = ctx.measureText(target.text);
                const padding = 25; // Horizontal padding
                const baseWidth = target.size * 1.2; // Min width based on asteroid
                const textWidth = metrics.width + padding;
                const boxWidth = Math.min(player.rect.width * 0.23, Math.max(baseWidth, textWidth)); // Dynamic width with max
                const boxHeight = 40; // Increased height
                const boxY = target.size / 2 - 10; // Position below asteroid

                // Draw Box
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.strokeStyle = '#60A5FA';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.roundRect(-boxWidth / 2, boxY, boxWidth, boxHeight, 8); // Use roundRect
                ctx.fill();
                ctx.stroke();

                // Draw Text
                ctx.fillStyle = '#FFFFFF';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(target.text, 0, boxY + boxHeight / 2);

                ctx.restore();
                target.y += target.speed;
            });
            player.targets = player.targets.filter(t => !t.hit && t.y < canvas.height + 100);
        }

        function shoot(player) { if (player.questionAnswered || player.isFinished || player.bullets.length >= 2 || player.shootCooldown > 0) return; playSound('shoot', player); player.bullets.push({ x: player.x, y: player.y - 50, vy: -15, owner: player }); player.shootCooldown = player.id === 1 ? 10 : 30; }
        function drawBullets(player) { player.bullets = player.bullets.filter(bullet => { bullet.y += bullet.vy; ctx.shadowColor = player.color; ctx.shadowBlur = 10; ctx.fillStyle = player.color; ctx.fillRect(bullet.x - 3, bullet.y - 10, 6, 20); ctx.shadowBlur = 0; return bullet.y > -20; }); }
        function createExplosion(x, y, color) { const particleCount = 30; for (let i = 0; i < particleCount; i++) { const angle = (Math.PI * 2 * i) / particleCount; const speed = 2 + Math.random() * 4; particles.push({ x: x, y: y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, life: 1, color: color, size: Math.random() * 3 + 1 }); } }
        function updateParticles() { particles = particles.filter(p => { p.x += p.vx; p.y += p.vy; p.vy += 0.1; p.life -= 0.015; if (p.life > 0) { ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2); ctx.fill(); ctx.globalAlpha = 1; return true; } return false; }); }
        function showCorrectAnswerPopup(player) { const correctTarget = player.targets.find(t => t.isCorrect); if (!correctTarget) return; const div = document.createElement('div'); div.style.position = 'fixed'; div.style.top = '60%'; div.style.left = player.id === 1 ? '25%' : '75%'; div.style.transform = 'translate(-50%, -50%)'; div.style.background = 'rgba(0, 200, 0, 0.7)'; div.style.border = '2px solid #10B981'; div.style.borderRadius = '10px'; div.style.padding = '15px 25px'; div.style.fontSize = '24px'; div.style.color = '#fff'; div.style.fontWeight = 'bold'; div.style.textAlign = 'center'; div.style.zIndex = '500'; div.style.animation = 'correctAnswerAnim 2s ease-out forwards'; div.innerHTML = `âœ… ${correctTarget.text}`; document.body.appendChild(div); setTimeout(() => div.remove(), 2000); }
        function createConfetti() { const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800']; for (let i = 0; i < 150; i++) { const confetti = document.createElement('div'); confetti.className = 'confetti'; confetti.style.left = Math.random() * 100 + 'vw'; confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)]; confetti.style.animationDuration = (Math.random() * 3 + 4) + 's'; confetti.style.animationDelay = (Math.random() * 2) + 's'; confetti.style.transform = `rotate(${Math.random() * 360}deg)`; endScreen.appendChild(confetti); } }
        function clearConfetti() { const existing = document.querySelectorAll('.confetti'); existing.forEach(c => c.remove()); }

        function checkCollisions(player) {
            if (player.isFinished) return;
            player.bullets.forEach(bullet => {
                player.targets.forEach(target => {
                    if (!target.hit && !player.questionAnswered &&
                        Math.abs(bullet.x - target.x) < target.size/2 + 10 && // Check original size for hit
                        Math.abs(bullet.y - target.y) < target.size/2 + 10) {
                        target.hit = true;
                        bullet.y = -100;
                        createExplosion(target.x, target.y, player.color);
                        playSound('hit', player);
                        processAnswer(player, target);
                    }
                });
            });

            if (!player.questionAnswered) {
                player.targets.forEach(target => {
                     if (!target.hit && target.y > canvas.height + 50 && !player.questionAnswered) {
                         player.questionAnswered = true;
                         player.combo = 0;
                         playSound('wrong', player);
                         showCorrectAnswerPopup(player);
                         player.wrongAnswers.push({ q: player.currentQuestionData.question, c: player.currentQuestionData.correctAnswer, w: "æœªä½œç­”" });
                         setTimeout(() => loadQuestion(player), 2000);
                     }
                });
            }
        }

        function processAnswer(player, target) {
            if (player.questionAnswered) return;

            player.questionAnswered = true;
            let delay = 1000;

            if (target.isCorrect) {
                player.score += 10;
                player.combo++;
                if (player.combo > player.maxCombo) player.maxCombo = player.combo;
                playSound('correct', player);
            } else {
                player.combo = 0;
                // player.lives--; // MODIFIED: No lives lost
                playSound('wrong', player);
                showCorrectAnswerPopup(player);
                delay = 2500;
                player.wrongAnswers.push({ q: player.currentQuestionData.question, c: player.currentQuestionData.correctAnswer, w: target.text });
            }

            updateUI(player);
            setTimeout(() => loadQuestion(player), delay); // Always load next Q
        }

        function loadQuestion(player) {
            if (player.isFinished) return;

            player.currentQuestionIndex++;

            // MODIFIED: Only check for > 10 questions
            if (player.currentQuestionIndex > 10) {
                player.isFinished = true;
                document.getElementById(`questionP${player.id}`).textContent = "å·²å®Œæˆ!";
                checkGameEnd();
                return;
            }

            player.currentQuestionData = player.questions[player.currentQuestionIndex - 1];

            if (!player.currentQuestionData) {
                console.error(`P${player.id} - FAILED to load question ${player.currentQuestionIndex}.`);
                player.isFinished = true;
                document.getElementById(`questionP${player.id}`).textContent = "é¢˜ç›®é”™è¯¯!";
                checkGameEnd();
                return;
            }

            document.getElementById(`questionP${player.id}`).textContent = player.currentQuestionData.question;
            player.questionAnswered = false;
            createTargets(player);
            updateUI(player);
        }

        function checkGameEnd() {
            if (player1.isFinished && player2.isFinished && gameState === 'playing') {
                endGame();
            }
        }

        function updateUI(player) {
            document.getElementById(`scoreP${player.id}`).textContent = player.score;
            document.getElementById(`currentP${player.id}`).textContent = Math.min(player.currentQuestionIndex, 10);
            document.getElementById(`comboP${player.id}`).textContent = player.combo;
            // document.getElementById(`livesP${player.id}`).textContent = Math.max(0, player.lives); // MODIFIED: Removed
        }

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBackground();

            if (gameState === 'playing') {
                if (player1.shootCooldown > 0) player1.shootCooldown--;
                if (player2.shootCooldown > 0) player2.shootCooldown--;
                updatePlayer2Movement();

                // P1 Side
                ctx.save();
                ctx.beginPath(); ctx.rect(p1Rect.x, p1Rect.y, p1Rect.width, p1Rect.height); ctx.clip();
                if (!player1.isFinished) { drawJ20(player1); drawTargets(player1); drawBullets(player1); }
                ctx.restore();

                // P2 Side
                ctx.save();
                ctx.beginPath(); ctx.rect(p2Rect.x, p2Rect.y, p2Rect.width, p2Rect.height); ctx.clip();
                 if (!player2.isFinished) { drawJ20(player2); drawTargets(player2); drawBullets(player2); }
                ctx.restore();

                updateParticles();
                checkCollisions(player1);
                checkCollisions(player2);

                crosshairP1.style.left = mouseX < p1Rect.width ? mouseX + 'px' : '-100px';
                crosshairP1.style.top = mouseY + 'px';
                crosshairP2.style.left = player2.x + 'px';
                crosshairP2.style.top = player2.y - 25 + 'px';
            }

            requestAnimationFrame(gameLoop);
        }
        function updatePlayer2Movement() { if(p2Keys.shoot) shoot(player2); }

        // --- Controls ---
        document.addEventListener('mousemove', (e) => { mouseX = e.clientX; mouseY = e.clientY; if (gameState === 'playing' && mouseX < p1Rect.width) { player1.targetX = mouseX; } document.body.style.cursor = (gameState === 'playing') ? 'none' : 'auto'; });
        canvas.addEventListener('click', (e) => { initAudio(); if (gameState === 'playing' && e.clientX < p1Rect.width) { shoot(player1); } });
        document.addEventListener('keydown', (e) => { initAudio(); if (gameState !== 'playing') return; switch(e.code) { case 'KeyA': p2Keys.left = true; break; case 'KeyD': p2Keys.right = true; break; case 'Space': p2Keys.shoot = true; break; } });
        document.addEventListener('keyup', (e) => { if (gameState !== 'playing') return; switch(e.code) { case 'KeyA': p2Keys.left = false; break; case 'KeyD': p2Keys.right = false; break; case 'Space': p2Keys.shoot = false; break; } });

        // --- Game State Functions ---
        function startGame() {
            initAudio();
            resizeCanvas();

            player1 = initPlayer(1, p1Rect, '#60A5FA', '#4A5568', '#1A202C');
            player2 = initPlayer(2, p2Rect, '#F472B6', '#71495A', '#452C36');

            let shuffled1 = [...questionBank].sort(() => 0.5 - Math.random());
            player1.questions = shuffled1.slice(0, 10);
            let shuffled2 = [...questionBank].sort(() => 0.5 - Math.random());
            player2.questions = shuffled2.slice(0, 10);

            gameState = 'playing';

            startScreen.style.display = 'none';
            endScreen.style.display = 'none';
            gameUI.style.display = 'flex';
            divider.style.display = 'block';
            document.body.style.cursor = 'none';

            clearConfetti();
            loadQuestion(player1);
            loadQuestion(player2);
        }

        function endGame() {
            if (gameState === 'ended') return;
            gameState = 'ended';

            gameUI.style.display = 'none';
            startScreen.style.display = 'none';
            endScreen.style.display = 'flex';
            divider.style.display = 'none';
            document.body.style.cursor = 'auto';

            document.getElementById('finalScoreP1').textContent = player1.score;
            document.getElementById('finalScoreP2').textContent = player2.score;

            const winnerDiv = document.getElementById('winnerDisplay');
            let winner = null;
            if (player1.score > player2.score) { winnerDiv.textContent = 'ğŸ† ç©å®¶ 1 è·èƒœ! ğŸ†'; winnerDiv.className = 'winner-display p1-win'; winner = player1; }
            else if (player2.score > player1.score) { winnerDiv.textContent = 'ğŸ† ç©å®¶ 2 è·èƒœ! ğŸ†'; winnerDiv.className = 'winner-display p2-win'; winner = player2; }
            else { winnerDiv.textContent = 'å¹³å±€!'; winnerDiv.className = 'winner-display draw'; }

            wrongAnswersDiv.innerHTML = '<h3 style="color: #FFD700; margin-bottom: 10px; font-size: 20px;">ğŸ“š é”™é¢˜å›é¡¾ï¼š</h3>';
            let allWrong = [...player1.wrongAnswers.map(w => ({...w, p: 1})), ...player2.wrongAnswers.map(w => ({...w, p: 2}))];
            if (allWrong.length > 0) {
                 allWrong.forEach((item, index) => {
                     wrongAnswersDiv.innerHTML += `<div class="wrong-item">
                         <div>${index + 1}. [ç©å®¶ ${item.p}] ${item.q}</div>
                         <div>âœ… æ­£ç¡®ï¼š${item.c} | âŒ é”™è¯¯ï¼š${item.w}</div>
                     </div>`;
                 });
            } else {
                 wrongAnswersDiv.innerHTML += '<p style="color: #10B981; font-size: 20px; text-align: center;">ğŸ‰ åŒæ–¹éƒ½æ²¡æœ‰é”™é¢˜ï¼</p>';
            }

            if (winner) { playSound('win'); createConfetti(); }
        }

        function restartGame() {
            clearConfetti();
            endScreen.style.display = 'none';
            gameUI.style.display = 'none';
            startScreen.style.display = 'flex';
            divider.style.display = 'none';
            gameState = 'menu';
        }

        // --- Initialisation ---
        window.onload = () => {
             createStars();
             resizeCanvas();
             gameLoop();
             startScreen.style.display = 'flex';
             gameUI.style.display = 'none';
             endScreen.style.display = 'none';
             divider.style.display = 'none';
             document.body.style.cursor = 'auto';
        };

    </script>
</body>
</html>
```
